// Amino Acid data structure - Full dataset
const aminoAcidData = {
    "Amino 16": {
        free: { "Alanine": 0.94, "Arginine": 0.68, "Aspartic Acid": 1.23, "Glutamic Acid": 2.75, "Glycine": 0.51, "Histidine": 0.32, "Isoleucine": 0.27, "Leucine": 0.97, "Lysine": 0.35, "Methionine": 0.25, "Phenylalanine": 0.43, "Proline": 1.01, "Serine": 0.65, "Threonine": 0.37, "Tyrosine": 0.42, "Valine": 0.74 },
        total: { "Alanine": 1.01, "Arginine": 0.98, "Aspartic Acid": 1.35, "Glutamic Acid": 4.48, "Glycine": 0.69, "Histidine": 0.66, "Isoleucine": 0.85, "Leucine": 1.72, "Lysine": 0.57, "Methionine": 0.35, "Phenylalanine": 0.98, "Proline": 1.8, "Serine": 0.84, "Threonine": 0.89, "Tyrosine": 0.88, "Valine": 0.95 }
    },
    "Fruitfix": {
        free: { "Alanine": 0.63, "Arginine": 0.46, "Aspartic Acid": 0.83, "Glutamic Acid": 1.86, "Glycine": 0.29, "Histidine": 0.22, "Isoleucine": 0.18, "Leucine": 0.65, "Lysine": 0.24, "Methionine": 0.17, "Phenylalanine": 0.29, "Proline": 0.68, "Serine": 0.44, "Threonine": 0.25, "Tyrosine": 0.28, "Valine": 0.5 },
        total: { "Alanine": 0.82, "Arginine": 0.73, "Aspartic Acid": 1.14, "Glutamic Acid": 2.91, "Glycine": 0.3, "Histidine": 0.42, "Isoleucine": 0.64, "Leucine": 2.28, "Lysine": 0.61, "Methionine": 0.21, "Phenylalanine": 1.12, "Proline": 1.43, "Serine": 0.64, "Threonine": 0.38, "Tyrosine": 0.63, "Valine": 1.11 }
    },
    "Granbrix": {
        free: { "Alanine": 0.58, "Arginine": 0.24, "Aspartic Acid": 0.84, "Glutamic Acid": 2.11, "Glycine": 0.19, "Histidine": 0.11, "Isoleucine": 0.14, "Leucine": 0.92, "Lysine": 0.19, "Methionine": 0.15, "Phenylalanine": 0.29, "Proline": 0.55, "Serine": 0.46, "Threonine": 0.16, "Tyrosine": 0.2, "Valine": 0.16 },
        total: { "Alanine": 1.05, "Arginine": 0.5, "Aspartic Acid": 0.92, "Glutamic Acid": 3.11, "Glycine": 0.62, "Histidine": 0.3, "Isoleucine": 0.56, "Leucine": 2.11, "Lysine": 0.32, "Methionine": 0.33, "Phenylalanine": 0.89, "Proline": 1.36, "Serine": 0.81, "Threonine": 0.41, "Tyrosine": 0.68, "Valine": 0.41 }
    },
    "MicroRS": {
        free: { "Alanine": 0.93, "Arginine": 0.38, "Aspartic Acid": 1.32, "Glutamic Acid": 3.15, "Glycine": 0.23, "Histidine": 0.15, "Isoleucine": 0.19, "Leucine": 1.36, "Lysine": 0.3, "Methionine": 0.07, "Phenylalanine": 0.4, "Proline": 0.67, "Serine": 0.69, "Threonine": 0.26, "Tyrosine": 0.3, "Valine": 0.18, "Cystine": 0.09, "Tryptophan": 0.03 },
        total: { "Alanine": 1.36, "Arginine": 0.73, "Aspartic Acid": 1.5, "Glutamic Acid": 4.09, "Glycine": 0.72, "Histidine": 0.38, "Isoleucine": 0.7, "Leucine": 2.99, "Lysine": 0.57, "Methionine": 0.23, "Phenylalanine": 1.08, "Proline": 1.77, "Serine": 0.93, "Threonine": 0.66, "Tyrosine": 0.95, "Valine": 0.73, "Cystine": 0.23, "Tryptophan": 0.03 }
    },
    "Amino Cell S": {
        free: { "Alanine": 1.11, "Arginine": 0.51, "Aspartic Acid": 1.77, "Glutamic Acid": 3.75, "Glycine": 0.52, "Histidine": 0.32, "Isoleucine": 0.42, "Leucine": 1.85, "Lysine": 0.3, "Methionine": 0.24, "Phenylalanine": 0.93, "Proline": 1.53, "Serine": 1.32, "Threonine": 0.6, "Tyrosine": 0.88, "Valine": 0.53, "Cystine": 0.17, "Tryptophan": 0.03 },
        total: { "Alanine": 1.32, "Arginine": 0.62, "Aspartic Acid": 1.92, "Glutamic Acid": 3.9, "Glycine": 0.55, "Histidine": 0.33, "Isoleucine": 0.54, "Leucine": 1.96, "Lysine": 0.42, "Methionine": 0.44, "Phenylalanine": 1.15, "Proline": 1.59, "Serine": 1.36, "Threonine": 0.76, "Tyrosine": 1.32, "Valine": 1.02, "Cystine": 0.23, "Tryptophan": 0.03 }
    },
    "Amino Cell PK": {
        free: { "Alanine": 0.95, "Arginine": 0.23, "Aspartic Acid": 0.75, "Glutamic Acid": 1.36, "Glycine": 0.52, "Histidine": 0.05, "Isoleucine": 0.19, "Leucine": 1.54, "Lysine": 0.16, "Methionine": 0.05, "Phenylalanine": 0.66, "Proline": 0.71, "Serine": 0.17, "Threonine": 0.23, "Tyrosine": 0.18, "Valine": 0.21, "Cystine": 0.03, "Tryptophan": 0.03 },
        total: { "Alanine": 1.09, "Arginine": 0.43, "Aspartic Acid": 0.99, "Glutamic Acid": 3.58, "Glycine": 0.61, "Histidine": 0.25, "Isoleucine": 0.71, "Leucine": 2.48, "Lysine": 0.35, "Methionine": 0.41, "Phenylalanine": 1.01, "Proline": 1.78, "Serine": 0.58, "Threonine": 0.49, "Tyrosine": 0.76, "Valine": 0.93, "Cystine": 0.06, "Tryptophan": 0.03 }
    },
    "Amino Cell Si 3%": {
        free: { "Alanine": 1.1, "Arginine": 0.37, "Aspartic Acid": 1.14, "Glutamic Acid": 2.71, "Glycine": 0.23, "Histidine": 0.27, "Isoleucine": 0.33, "Leucine": 1.57, "Lysine": 0.31, "Methionine": 0.47, "Phenylalanine": 0.79, "Proline": 1.08, "Serine": 0.72, "Threonine": 0.42, "Tyrosine": 0.45, "Valine": 0.49, "Cystine": 0.04, "Tryptophan": 0.03 },
        total: { "Alanine": 1.3, "Arginine": 0.65, "Aspartic Acid": 1.38, "Glutamic Acid": 4.57, "Glycine": 0.31, "Histidine": 0.45, "Isoleucine": 0.39, "Leucine": 1.83, "Lysine": 0.35, "Methionine": 0.53, "Phenylalanine": 1.25, "Proline": 1.77, "Serine": 1.1, "Threonine": 0.57, "Tyrosine": 0.67, "Valine": 0.58, "Cystine": 0.06, "Tryptophan": 0.03 }
    },
    "Amino Cell Antistress": {
        free: { "Alanine": 1.01, "Arginine": 0.51, "Aspartic Acid": 1.17, "Glutamic Acid": 3.53, "Glycine": 0.42, "Histidine": 0.29, "Isoleucine": 0.52, "Leucine": 1.63, "Lysine": 0.3, "Methionine": 0.24, "Phenylalanine": 0.7, "Proline": 1.64, "Serine": 0.7, "Threonine": 0.54, "Tyrosine": 0.66, "Valine": 0.53, "Cystine": 0.08, "Tryptophan": 0.03 },
        total: { "Alanine": 1.14, "Arginine": 0.72, "Aspartic Acid": 1.37, "Glutamic Acid": 4.25, "Glycine": 0.46, "Histidine": 0.4, "Isoleucine": 0.9, "Leucine": 2.54, "Lysine": 0.57, "Methionine": 0.39, "Phenylalanine": 0.89, "Proline": 1.71, "Serine": 0.86, "Threonine": 0.66, "Tyrosine": 0.77, "Valine": 0.93, "Cystine": 0.08, "Tryptophan": 0.03 }
    },
    "Ultra Green": {
        free: { "Alanine": 0.39, "Arginine": 0.48, "Aspartic Acid": 0.96, "Glutamic Acid": 1.61, "Glycine": 0.63, "Histidine": 0.14, "Isoleucine": 0.11, "Leucine": 0.34, "Lysine": 0.25, "Methionine": 0.12, "Phenylalanine": 0.26, "Proline": 0.27, "Serine": 0.35, "Threonine": 0.2, "Tyrosine": 0.14, "Valine": 0.15 },
        total: { "Alanine": 0.65, "Arginine": 0.88, "Aspartic Acid": 1.23, "Glutamic Acid": 2.75, "Glycine": 0.84, "Histidine": 0.31, "Isoleucine": 0.6, "Leucine": 0.8, "Lysine": 0.49, "Methionine": 0.34, "Phenylalanine": 0.57, "Proline": 0.7, "Serine": 0.56, "Threonine": 0.51, "Tyrosine": 0.39, "Valine": 0.7 }
    },
    "Amino HF": {
        free: { "Alanine": 0.46, "Arginine": 0.3, "Aspartic Acid": 0.61, "Glutamic Acid": 1.44, "Glycine": 0.14, "Histidine": 0.19, "Isoleucine": 0.2, "Leucine": 1.24, "Lysine": 0.24, "Methionine": 0.16, "Phenylalanine": 0.44, "Proline": 0.83, "Serine": 0.3, "Threonine": 0.22, "Tyrosine": 0.16, "Valine": 0.31, "Cystine": 0.03, "Tryptophan": 0.01 },
        total: { "Alanine": 0.53, "Arginine": 0.48, "Aspartic Acid": 0.71, "Glutamic Acid": 1.84, "Glycine": 0.19, "Histidine": 0.29, "Isoleucine": 0.4, "Leucine": 1.43, "Lysine": 0.38, "Methionine": 0.17, "Phenylalanine": 0.71, "Proline": 0.91, "Serine": 0.41, "Threonine": 0.24, "Tyrosine": 0.42, "Valine": 0.71, "Cystine": 0.05, "Tryptophan": 0.01 }
    },
    "Amino 16 BZn": {
        free: { "Alanine": 0.78, "Arginine": 0.59, "Aspartic Acid": 1.04, "Glutamic Acid": 2.28, "Glycine": 0.48, "Histidine": 0.29, "Isoleucine": 0.25, "Leucine": 0.84, "Lysine": 0.29, "Methionine": 0.2, "Phenylalanine": 0.35, "Proline": 0.83, "Serine": 0.53, "Threonine": 0.3, "Tyrosine": 0.34, "Valine": 0.61 },
        total: { "Alanine": 0.83, "Arginine": 0.8, "Aspartic Acid": 1.1, "Glutamic Acid": 3.66, "Glycine": 0.56, "Histidine": 0.54, "Isoleucine": 0.69, "Leucine": 1.41, "Lysine": 0.47, "Methionine": 0.29, "Phenylalanine": 0.8, "Proline": 1.47, "Serine": 0.69, "Threonine": 0.73, "Tyrosine": 0.72, "Valine": 0.78 }
    },
    "Amino Power": {
        free: { "Alanine": 0.78, "Arginine": 0.31, "Aspartic Acid": 1.06, "Glutamic Acid": 1.75, "Glycine": 0.27, "Histidine": 0.17, "Isoleucine": 0.45, "Leucine": 1.19, "Lysine": 0.5, "Methionine": 0.14, "Phenylalanine": 0.81, "Proline": 0.74, "Serine": 0.58, "Threonine": 0.42, "Tyrosine": 0.34, "Valine": 0.43, "Cystine": 0.08, "Tryptophan": 0.02 },
        total: { "Alanine": 1, "Arginine": 0.74, "Aspartic Acid": 1.13, "Glutamic Acid": 2.45, "Glycine": 0.72, "Histidine": 0.34, "Isoleucine": 0.64, "Leucine": 1.55, "Lysine": 0.59, "Methionine": 0.28, "Phenylalanine": 1.38, "Proline": 0.95, "Serine": 0.67, "Threonine": 0.63, "Tyrosine": 0.51, "Valine": 0.76, "Cystine": 0.12, "Tryptophan": 0.03 }
    }
};

let aminogramChart = null;

function calculateMetrics(productName) {
    const product = aminoAcidData[productName];
    if (!product) return null;

    const free = product.free;
    const total = product.total;

    const totalFree = Object.values(free).reduce((a, b) => a + b, 0);
    const totalTotal = Object.values(total).reduce((a, b) => a + b, 0);

    const metrics = {};

    // 1. Functional Diversity Score
    const glutamicAsp = ((total["Glutamic Acid"] || 0) + (total["Aspartic Acid"] || 0)) / totalTotal * 100;
    metrics.functionalDiversity = {
        name: "Functional Diversity",
        value: glutamicAsp.toFixed(1) + "%",
        target: "<30-35%",
        status: glutamicAsp < 30 ? "excellent" : glutamicAsp <= 35 ? "good" : "poor",
        description: "Glutamic + Aspartic acid %"
    };

    // 2. Osmotic Balance
    const prolinePct = (total["Proline"] || 0) / totalTotal * 100;
    metrics.osmoticBalance = {
        name: "Osmotic Balance - ROS",
        value: prolinePct.toFixed(1) + "%",
        target: ">6%",
        status: prolinePct > 6 ? "excellent" : "poor",
        description: "Proline percentage"
    };

    // 3. BCAA Benchmark
    const leu = (total["Leucine"] || 0) / totalTotal * 100;
    const ile = (total["Isoleucine"] || 0) / totalTotal * 100;
    const val = (total["Valine"] || 0) / totalTotal * 100;
    const bcaa = leu + ile + val;
    metrics.bcaa = {
        name: "BCAA Benchmark",
        value: bcaa.toFixed(1) + "% (Leu: " + leu.toFixed(1) + "%)",
        target: "BCAA >8% + Leu >3%",
        status: (bcaa > 8 && leu > 3) ? "excellent" : "poor",
        description: "Branched-chain amino acids"
    };

    // 4. Free AA Availability
    const freeRatio = (totalFree / totalTotal) * 100;
    let freeStatus = "poor";
    if (freeRatio >= 70) freeStatus = "excellent";
    else if (freeRatio >= 55) freeStatus = "good";
    else if (freeRatio >= 40) freeStatus = "moderate";
    metrics.freeAA = {
        name: "Free AA Availability",
        value: freeRatio.toFixed(1) + "%",
        target: ">70% Excellent",
        status: freeStatus,
        description: "Free/Total amino acids ratio"
    };

    // 5. Combined Osmoprotectants
    const prolineGL = total["Proline"] || 0;
    metrics.osmoprotectants = {
        name: "Combined Osmoprotectants",
        value: prolineGL.toFixed(2) + " g/L",
        target: ">8 g/L",
        status: prolineGL > 8 ? "excellent" : "moderate",
        description: "Proline g/L (primary osmoprotectant)"
    };

    // 6. Stress-focused
    const stressAA = ((total["Proline"] || 0) + (total["Arginine"] || 0) + (total["Glycine"] || 0) + (total["Serine"] || 0)) / totalTotal * 100;
    metrics.stressFocused = {
        name: "Stress-Focused",
        value: stressAA.toFixed(1) + "%",
        target: ">14%",
        status: stressAA > 14 ? "excellent" : "poor",
        description: "Pro + Arg + Gly + Ser"
    };

    // 7. Vegetative / Recovery
    const vegetativeAA = ((total["Glutamic Acid"] || 0) + (total["Aspartic Acid"] || 0) + (total["Alanine"] || 0)) / totalTotal * 100;
    metrics.vegetative = {
        name: "Vegetative / Recovery",
        value: vegetativeAA.toFixed(1) + "%",
        target: ">30%",
        status: vegetativeAA > 30 ? "excellent" : "poor",
        description: "Glu + Asp + Ala"
    };

    // 8. Chelation Capacity
    const chelationAA = ((total["Glycine"] || 0) + (total["Aspartic Acid"] || 0) + (total["Glutamic Acid"] || 0)) / totalTotal * 100;
    metrics.chelation = {
        name: "Chelation Capacity",
        value: chelationAA.toFixed(1) + "%",
        target: ">15%",
        status: chelationAA > 15 ? "excellent" : "poor",
        description: "Gly + Asp + Glu"
    };

    // 9. Rooting / Early growth
    const rootingAA = ((total["Arginine"] || 0) + (total["Proline"] || 0)) / totalTotal * 100;
    metrics.rooting = {
        name: "Rooting / Early Growth",
        value: rootingAA.toFixed(1) + "%",
        target: ">10%",
        status: rootingAA > 10 ? "excellent" : "poor",
        description: "Arg + Pro (Ornithine not in dataset)"
    };

    // 10. Flowering
    const floweringAA = ((total["Arginine"] || 0) + (total["Phenylalanine"] || 0) + (total["Methionine"] || 0)) / totalTotal * 100;
    metrics.flowering = {
        name: "Flowering Support",
        value: floweringAA.toFixed(1) + "%",
        target: ">6%",
        status: floweringAA > 6 ? "excellent" : "poor",
        description: "Arg + Phe + Met"
    };

    // 11. General Metabolic support
    metrics.metabolicSupport = {
        name: "Metabolic Support",
        value: totalFree.toFixed(1) + " g/L",
        target: ">13 g/L Good",
        status: totalFree > 13 ? "good" : "moderate",
        description: "Free AA concentration"
    };

    // 12. EAAI Index
    const eaai = ((free["Methionine"] || 0) + (free["Cystine"] || 0) + (free["Lysine"] || 0) + (free["Threonine"] || 0) + (free["Tryptophan"] || 0)) / totalFree * 100;
    let eaaiStatus = "medium";
    if (eaai >= 8) eaaiStatus = "excellent";
    else if (eaai >= 6) eaaiStatus = "good";
    metrics.eaai = {
        name: "EAAI Index",
        value: eaai.toFixed(1) + "%",
        target: "≥8% Excellent",
        status: eaaiStatus,
        description: "(Met+Cys+Lys+Thr+Trp)/Total Free"
    };

    // 13. Nitrogen efficiency index
    const nei = ((free["Lysine"] || 0) + (free["Histidine"] || 0) + (free["Arginine"] || 0)) / totalFree * 100;
    let neiStatus = "medium";
    if (nei >= 9) neiStatus = "excellent";
    else if (nei >= 7) neiStatus = "good";
    metrics.nitrogenEfficiency = {
        name: "Nitrogen Efficiency",
        value: nei.toFixed(1) + "%",
        target: "≥9% Excellent",
        status: neiStatus,
        description: "(Lys+His+Arg)/Total Free"
    };

    return metrics;
}

function updateSpecifications() {
    const selectedProduct = document.getElementById('specsProduct').value;
    const specsContent = document.getElementById('specsContent');
    const noSpecsMessage = document.getElementById('noSpecsMessage');

    if (!selectedProduct) {
        specsContent.style.display = 'none';
        noSpecsMessage.style.display = 'block';
        return;
    }

    noSpecsMessage.style.display = 'none';
    specsContent.style.display = 'block';

    updateAminogramChart(selectedProduct);
    const metrics = calculateMetrics(selectedProduct);
    updateMetricsGrid(metrics);
}

function updateAminogramChart(productName) {
    const product = aminoAcidData[productName];
    const total = product.total;

    const sortedAA = Object.entries(total).sort((a, b) => b[1] - a[1]).slice(0, 12);
    const labels = sortedAA.map(([name]) => name);
    const data = sortedAA.map(([, value]) => value);

    if (aminogramChart) {
        aminogramChart.destroy();
    }

    const ctx = document.getElementById('aminogramChart').getContext('2d');
    
    aminogramChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    'rgba(26, 77, 46, 0.9)', 'rgba(45, 122, 79, 0.9)', 'rgba(255, 159, 28, 0.9)',
                    'rgba(26, 77, 46, 0.7)', 'rgba(45, 122, 79, 0.7)', 'rgba(255, 159, 28, 0.7)',
                    'rgba(26, 77, 46, 0.5)', 'rgba(45, 122, 79, 0.5)', 'rgba(255, 159, 28, 0.5)',
                    'rgba(26, 77, 46, 0.3)', 'rgba(45, 122, 79, 0.3)', 'rgba(255, 159, 28, 0.3)'
                ],
                borderColor: 'rgba(255, 255, 255, 0.8)',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        font: { size: 14, family: "'DM Sans', sans-serif", weight: '500' },
                        padding: 18,
                        color: '#2c3e2f',
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 77, 46, 0.95)',
                    padding: 12,
                    titleFont: { size: 14, weight: '600' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(2) + ' g/L';
                        }
                    }
                }
            },
            scales: {
                r: {
                    ticks: {
                        backdropColor: 'transparent',
                        color: '#6b7c6e',
                        font: { size: 12 }
                    },
                    grid: {
                        color: 'rgba(26, 77, 46, 0.15)',
                        lineWidth: 2
                    },
                    angleLines: {
                        color: 'rgba(26, 77, 46, 0.1)'
                    }
                }
            }
        }
    });
}

function updateMetricsGrid(metrics) {
    const metricsGrid = document.getElementById('metricsGrid');
    metricsGrid.innerHTML = '';

    Object.values(metrics).forEach(metric => {
        const card = document.createElement('div');
        card.className = `metric-card metric-${metric.status}`;
        
        card.innerHTML = `
            <div class="metric-status-badge ${metric.status}">${metric.status.toUpperCase()}</div>
            <h4 class="metric-name">${metric.name}</h4>
            <div class="metric-value">${metric.value}</div>
            <div class="metric-target">Target: ${metric.target}</div>
            <div class="metric-description">${metric.description}</div>
        `;
        
        metricsGrid.appendChild(card);
    });
}
